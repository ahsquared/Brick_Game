/*!
 * Multi-Touch enabled jQuery.event.drag
 * http://addictivity.de/jquery-drag-evâ€¦it-multi-touch/
 * @license Open Source MIT
 * @author Fabian Arnold <http://addictivity.de/>
 * @release 0.1
 *
 * @original-license
 * http://www.shamasis.net/projects/jquery-drag-touch/
 * @license Open Source MIT
 * @author Shamasis Bhattacharya <http://www.shamasis.net/>
 * @release 2.0.1
 *
 * @original-license
 * jquery.event.drag - v 2.0.0
 * Copyright (c) 2010 Three Dub Media - http://threedubmedia.com
 * Open Source MIT License - http://threedubmedia.com/code/license
 */
 
(function(a){a.fn.drag=function(b,c,d){var e=typeof b=="string"?b:"",f=a.isFunction(b)?b:a.isFunction(c)?c:null;if(e.indexOf("drag")!==0)e="drag"+e;d=(b==f?c:d)||{};return f?this.bind(e,d,f):this.trigger(e)};var b=a.event,c="ontouchstart"in document.documentElement,d=c?"touchstart":"mousedown",e=c?"touchmove touchend":"mousemove mouseup",f=function(b,c){if(!c.touchXY||!b.originalEvent){return b}var d=b.originalEvent.changedTouches||b.originalEvent.touches;if(d&&d.length){a.extend(b,d[0])}return b},g=b.special,h=g.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:false,drop:false,click:false,touchXY:true},datakey:"dragdata",livekey:"livedrag",add:function(c){var d=a.data(this,h.datakey),e=c.data||{};d.related+=1;if(!d.live&&c.selector){d.live=true;b.add(this,"draginit."+h.livekey,h.delegate)}a.each(h.defaults,function(a,b){if(e[a]!==undefined)d[a]=e[a]})},remove:function(){a.data(this,h.datakey).related-=1},setup:function(){if(a.data(this,h.datakey))return;var c=a.extend({related:0},h.defaults);a.data(this,h.datakey,c);b.add(this,d,h.init,c);if(this.attachEvent)this.attachEvent("ondragstart",h.dontstart)},teardown:function(){if(a.data(this,h.datakey).related)return;a.removeData(this,h.datakey);b.remove(this,d,h.init);b.remove(this,"draginit",h.delegate);h.textselect(true);if(this.detachEvent)this.detachEvent("ondragstart",h.dontstart)},init:function(d){var f=d.data,i,j=d.originalEvent?d.originalEvent.changedTouches||d.originalEvent.touches:[];if(j&&j.length){if(j.length>1){return}var k=d.originalEvent.touches[0].pageX;var l=d.originalEvent.touches[0].pageY}else{if(f.which>0&&d.which!=f.which){return}var k=d.pageX;var l=d.pageY}if(a(d.target).is(f.not))return;if(f.handle&&!a(d.target).closest(f.handle,d.currentTarget).length)return;f.propagates=1;f.interactions=[h.interaction(this,f)];f.target=d.target;f.pageX=k;f.pageY=l;f.dragging=null;i=h.hijack(d,"draginit",f);if(!f.propagates)return;i=h.flatten(i);if(i&&i.length){f.interactions=[];a.each(i,function(){f.interactions.push(h.interaction(this,f))})}f.propagates=f.interactions.length;if(f.drop!==false&&g.drop)g.drop.handler(d,f);h.textselect(false);b.add(document,e,h.handler,f);if(!c){return false}},interaction:function(b,c){return{drag:b,callback:new h.callback,droppable:[],offset:a(b)[c.relative?"position":"offset"]()||{top:0,left:0}}},handler:function(a){var c=a.data;if(!c.dragging&&(a.type==="mousemove"||a.type==="touchmove")){if(Math.pow(a.pageX-c.pageX,2)+Math.pow(a.pageY-c.pageY,2)<Math.pow(c.distance,2))return;a.target=c.target;h.hijack(a,"dragstart",c);if(c.propagates)c.dragging=true}switch(a.type){case"touchmove":if(c.dragging){a.preventDefault();f(a,c)};case"mousemove":if(c.dragging){h.hijack(a,"drag",c);if(c.propagates){if(c.drop!==false&&g.drop)g.drop.handler(a,c);break}a.type="mouseup"};case"mouseup":case"touchend":b.remove(document,e,h.handler);if(c.dragging){if(c.drop!==false&&g.drop)g.drop.handler(a,c);h.hijack(a,"dragend",c)}h.textselect(true);if(c.click===false&&c.dragging){jQuery.event.triggered=true;setTimeout(function(){jQuery.event.triggered=false},20);c.dragging=false}break}},delegate:function(c){var d=[],e,f=a.data(this,"events")||{};a.each(f.live||[],function(f,g){if(g.preType.indexOf("drag")!==0)return;e=a(c.target).closest(g.selector,c.currentTarget)[0];if(!e)return;b.add(e,g.origType+"."+h.livekey,g.origHandler,g.data);if(a.inArray(e,d)<0)d.push(e)});if(!d.length)return false;return a(d).bind("dragend."+h.livekey,function(){b.remove(this,"."+h.livekey)})},hijack:function(c,d,e,f,g){if(!e)return;var i={event:c.originalEvent,type:c.type},j=d.indexOf("drop")?"drag":"drop",k,l=f||0,m,n,o,p=!isNaN(f)?f:e.interactions.length;c.type=d;c.sourceEvent=i.event;c.originalEvent=null;e.results=[];do if(m=e.interactions[l]){if(d!=="dragend"&&m.cancelled)continue;o=h.properties(c,e,m);m.results=[];a(g||m[j]||e.droppable).each(function(f,g){o.target=g;k=g?b.handle.call(g,c,o):null;if(k===false){if(j=="drag"){m.cancelled=true;e.propagates-=1}if(d=="drop"){m[j][f]=null}}else if(d=="dropinit")m.droppable.push(h.element(k)||g);if(d=="dragstart")m.proxy=a(h.element(k)||m.drag)[0];m.results.push(k);delete c.result;if(d!=="dropinit")return k});e.results[l]=h.flatten(m.results);if(d=="dropinit")m.droppable=h.flatten(m.droppable);if(d=="dragstart"&&!m.cancelled)o.update()}while(++l<p);c.type=i.type;c.originalEvent=i.event;return h.flatten(e.results)},properties:function(a,b,c){var d=c.callback;d.drag=c.drag;d.proxy=c.proxy||c.drag;d.startX=b.pageX;d.startY=b.pageY;d.deltaX=a.pageX-b.pageX;d.deltaY=a.pageY-b.pageY;d.originalX=c.offset.left;d.originalY=c.offset.top;d.offsetX=a.pageX-(b.pageX-d.originalX);d.offsetY=a.pageY-(b.pageY-d.originalY);d.drop=h.flatten((c.drop||[]).slice());d.available=h.flatten((c.droppable||[]).slice());return d},element:function(a){if(a&&(a.jquery||a.nodeType==1))return a},flatten:function(b){return a.map(b,function(b){return b&&b.jquery?a.makeArray(b):b&&b.length?h.flatten(b):b})},textselect:function(b){a(document)[b?"unbind":"bind"]("selectstart",h.dontstart).attr("unselectable",b?"off":"on").css("MozUserSelect",b?"":"none")},dontstart:function(){return false},callback:function(){}};h.callback.prototype={update:function(){if(g.drop&&this.available.length)a.each(this.available,function(a){g.drop.locate(this,a)})}};g.draginit=g.dragstart=g.dragend=h})(jQuery)